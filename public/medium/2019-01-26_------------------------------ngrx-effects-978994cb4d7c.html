<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Хорошие способы использования ngrx/effects</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Хорошие способы использования ngrx/effects</h1>
</header>
<section data-field="subtitle" class="p-summary">
Оригинал статьи Документация ngrx Справочник RxJS
</section>
<section data-field="body" class="e-content">
<section name="9322" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="9693" id="9693" class="graf graf--h3 graf--leading graf--title">Хорошие способы использования ngrx/effects</h3><p name="4a72" id="4a72" class="graf graf--p graf-after--h3"><a href="https://blog.angularindepth.com/start-using-ngrx-effects-for-this-e0b2bd9da165" data-href="https://blog.angularindepth.com/start-using-ngrx-effects-for-this-e0b2bd9da165" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Оригинал статьи</a> <a href="https://ngrx.io/docs" data-href="https://ngrx.io/docs" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Документация ngrx</a> <a href="https://stackblitz.com/edit/rxjs-aj4vwd" data-href="https://stackblitz.com/edit/rxjs-aj4vwd" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Справочник RxJS</a></p><figure name="456f" id="456f" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 521px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 74.4%;"></div><img class="graf-image" data-image-id="1*WposivQdECqKMGNZpfksww.jpeg" data-width="800" data-height="595" src="https://cdn-images-1.medium.com/max/800/1*WposivQdECqKMGNZpfksww.jpeg"></div><figcaption class="imageCaption">Фотография <a href="https://unsplash.com/@clement_gerbaud?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com/@clement_gerbaud?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-creator noopener noopener" target="_blank">Clément Gerbaud</a> из <a href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-source noopener noopener" target="_blank">Unsplash</a></figcaption></figure><p name="776b" id="776b" class="graf graf--p graf-after--figure">Скорее всего, вы используете библиотеку эффектов (<code class="markup--code markup--p-code">ngrx/Effects</code>) только для коммуникации с внешним источником, вызывая побочный эффект (<code class="markup--code markup--p-code">ngrx/Effect</code>) с помощью действия (<code class="markup--code markup--p-code">ngrx/Action</code>). Но знаете ли вы, что библиотеку эффектов можно использовать для чего-то ещё?</p><h3 name="7b12" id="7b12" class="graf graf--h3 graf-after--p"><strong class="markup--strong markup--h3-strong">ngrx/Effects</strong></h3><p name="d8d5" id="d8d5" class="graf graf--p graf-after--h3">Библиотека эффектов предоставляет способ изолировать побочные эффекты в своей собственной модели, вне хранилища (<code class="markup--code markup--p-code">ngrx/Store</code>) и компонентов Angular. Она предоставляет нам наблюдаемые действия (<code class="markup--code markup--p-code">Observable/actions</code>), проще говоря — поток(<code class="markup--code markup--p-code">stream</code>) всех отправленных (<code class="markup--code markup--p-code">dispatched</code>) действий. Для каждого отправленного действия она вызывает редуктор (<code class="markup--code markup--p-code">ngrx/Reducer</code>), и создаёт новое значение. Она также предоставляет <code class="markup--code markup--p-code">RxJS</code> оператор <code class="markup--code markup--p-code">ofType</code>, который используется для фильтрации действий по их типу.</p><p name="c747" id="c747" class="graf graf--p graf-after--p">Типичный эффект использует наблюдаемые действия в качестве источника и использует оператор <code class="markup--code markup--p-code">ofType</code> для выполнения своего побочного эффекта только при отправке соответствующего действия. Например, мы хотим получить список клиентов из внешнего ресурса.</p><p name="73a9" id="73a9" class="graf graf--p graf-after--p">Для этого нам нужно создать эффект <code class="markup--code markup--p-code">getCustomers</code>. Этот эффект прослушивает каждое отправляемое действие, и когда он получает действие с типом <code class="markup--code markup--p-code">[Customers Page] Get</code>, то он отправляет HTTP-запрос. В зависимости от ответа эффект будет отправлять действие <code class="markup--code markup--p-code">GetCustomersSuccess</code>, если запрос был успешным, или действие <code class="markup--code markup--p-code">GetCustomersFailed</code>, если запрос вернул ошибку. Чтобы найти клиентов, мы должны отправить действие <code class="markup--code markup--p-code">GetCustomers</code>.</p><p name="e2dd" id="e2dd" class="graf graf--p graf-after--p">Внутри нашего компонента, где мы хотим показать список всех клиентов, мы должны использовать селектор, чтобы выбрать всех клиентов из состояния хранилища.</p><figure name="2f70" id="2f70" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/bskydive/a4a4f33594ef2fa47bd09165418806ea.js"></script></figure><h3 name="7def" id="7def" class="graf graf--h3 graf-after--figure">1. Внешние ресурсы</h3><p name="0ad4" id="0ad4" class="graf graf--p graf-after--h3">Наблюдаемые действия являются наиболее известным, и наиболее часто используемым источником ваших эффектов. Однако, мы можем использовать любой наблюдаемый объект (<code class="markup--code markup--p-code">Observable</code>) в качестве источника.</p><h4 name="0dbe" id="0dbe" class="graf graf--h4 graf-after--p">Используем наблюдаемые объекты RxJS</h4><figure name="5ae2" id="5ae2" class="graf graf--figure graf--iframe graf-after--h4"><script src="https://gist.github.com/bskydive/39de05ae9361db7583ce1de8b355e7d6.js"></script></figure><h4 name="78e2" id="78e2" class="graf graf--h4 graf-after--figure">Используем JavaScript API и RxJS</h4><figure name="2a13" id="2a13" class="graf graf--figure graf--iframe graf-after--h4"><script src="https://gist.github.com/bskydive/1165813718dcebbbf52893ab89240692.js"></script></figure><h4 name="a5f4" id="a5f4" class="graf graf--h4 graf-after--figure">Используем Angular Material CDK</h4><figure name="af94" id="af94" class="graf graf--figure graf--iframe graf-after--h4"><script src="https://gist.github.com/bskydive/2e16038f53ab20354e48f982de472ada.js"></script></figure><h3 name="81a7" id="81a7" class="graf graf--h3 graf-after--figure">2. Перехват действий диалоговых окон Angular Material</h3><p name="9286" id="9286" class="graf graf--p graf-after--h3">Вместо обработки действий диалога внутри компонента можно использовать эффект. Эффект определяет, когда открывать и закрывать диалог, и отправляет действие с результатом диалога.</p><figure name="80b1" id="80b1" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/bskydive/e3de25ad54a90b4d7edddba2b5742243.js"></script></figure><h3 name="fee8" id="fee8" class="graf graf--h3 graf-after--figure">3. Показываем уведомления</h3><p name="c003" id="c003" class="graf graf--p graf-after--h3">Обработка уведомлений внутри эффекта делает остальную часть вашего приложения чистой и более понятной. Рассмотрим пример окна напоминалки на базе <a href="https://material.angular.io/components/snack-bar/overview" data-href="https://material.angular.io/components/snack-bar/overview" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Snackbar</a> <code class="markup--code markup--p-code">Angular Material</code>.</p><figure name="ae28" id="ae28" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/bskydive/0b2bf15e190c4d69aa380a7ec47b1cb7.js"></script></figure><p name="ad5d" id="ad5d" class="graf graf--p graf-after--figure">Или окна ошибки</p><figure name="eff1" id="eff1" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/bskydive/5f17644e2072dc14fbd4e0fabff03e05.js"></script></figure><h3 name="a97c" id="a97c" class="graf graf--h3 graf-after--figure">4. Используем селектор внутри эффектов</h3><p name="9d2c" id="9d2c" class="graf graf--p graf-after--h3">Иногда вам нужно получить доступ к состоянию хранилища (<code class="markup--code markup--p-code">ngrx\Store</code>) внутри эффекта. Для этого мы можем использовать оператор RxJS <code class="markup--code markup--p-code">withLatestFrom</code> в сочетании с селектором для получения фрагмента (<code class="markup--code markup--p-code">slice</code>) состояния хранилища.</p><figure name="64ca" id="64ca" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/bskydive/2f2dfba12a9e121b42ca9d6cf5da27e1.js"></script></figure><p name="7c3a" id="7c3a" class="graf graf--p graf-after--figure">Чтобы сделать следующий шаг, мы можем использовать данные, полученные селектором, чтобы проверить, существует ли уже сущность в хранилище. Это дает нам возможность блокировать ненужные запросы <code class="markup--code markup--p-code">GET</code>, если объект уже сохранен в хранилище.</p><figure name="165f" id="165f" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/bskydive/2c38fee1833d2cac022250164d169fee.js"></script></figure><h3 name="03e8" id="03e8" class="graf graf--h3 graf-after--figure">5. Навигация на основе действий</h3><p name="d50f" id="d50f" class="graf graf--p graf-after--h3">Внедряя (<code class="markup--code markup--p-code">inject</code>) маршрут(<code class="markup--code markup--p-code">Angular router</code><strong class="markup--strong markup--p-strong">)</strong> в эффекты, можно перенаправить пользователя на основе определенных действий. В приведенном ниже примере мы отправляем пользователя на домашнюю страницу, когда он или она выходит из системы.<br>Обратите внимание, что мы передаем <code class="markup--code markup--p-code">@Effect({dispatch:false})</code>, потому что мы не отправляем никакого события. Если бы мы этого не сделали, мы бы застряли в бесконечном цикле, потому что эффект повторяет одно и то же действие снова и снова.</p><figure name="ff7c" id="ff7c" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/bskydive/25bf82d780d32c5294961af3b825a6e7.js"></script></figure><h3 name="0c5c" id="0c5c" class="graf graf--h3 graf-after--figure">6. Аналитика / мониторинг</h3><p name="4895" id="4895" class="graf graf--p graf-after--h3">Поскольку каждое отправленное действие генерирует новое значение для источника действий, мы можем использовать этот источник для получения статистики приложения. Мы можем регистрировать все действия или некоторые, фильтруя их с помощью оператора <code class="markup--code markup--p-code">ofType</code>. В приведенном ниже примере мы регистрируем каждое действие в <code class="markup--code markup--p-code">appInsights</code>.</p><figure name="3099" id="3099" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/bskydive/b5d18622d7cecccc7f6d8defcac3eaac.js"></script></figure><h3 name="1e62" id="1e62" class="graf graf--h3 graf-after--figure">Заключение</h3><p name="8c89" id="8c89" class="graf graf--p graf-after--h3">Используя эти способы, мы можем переместить часть кода из наших компонентов или <code class="markup--code markup--p-code">ngrx/Store</code>, в модель <code class="markup--code markup--p-code">ngrx/Effects</code>. Это сделает компоненты более чистыми, и поможет хранить побочные эффекты нашего приложения отдельно. В результате получается код, который легче понимать и тестировать.</p><p name="058d" id="058d" class="graf graf--p graf-after--p">Теперь, когда вы знаете, в каких случаях эффекты можно использовать, стоит посмотреть когда этого делать не стоит.</p><p name="b86b" id="b86b" class="graf graf--p graf-after--p"><a href="https://medium.com/@stepanovv.ru/%D1%87%D0%B0%D1%81%D1%82%D1%8C-2-%D0%BF%D1%80%D0%B5%D0%BA%D1%80%D0%B0%D1%82%D0%B8%D1%82%D0%B5-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D1%8C-ngrx-effects-%D0%B4%D0%BB%D1%8F-%D1%8D%D1%82%D0%BE%D0%B3%D0%BE-6dec8fa90577" data-href="https://medium.com/@stepanovv.ru/%D1%87%D0%B0%D1%81%D1%82%D1%8C-2-%D0%BF%D1%80%D0%B5%D0%BA%D1%80%D0%B0%D1%82%D0%B8%D1%82%D0%B5-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D1%8C-ngrx-effects-%D0%B4%D0%BB%D1%8F-%D1%8D%D1%82%D0%BE%D0%B3%D0%BE-6dec8fa90577" class="markup--anchor markup--p-anchor" target="_blank"><em class="markup--em markup--p-em">Плохие способы использования ngrx/effects</em></a></p><blockquote name="2457" id="2457" class="graf graf--blockquote graf-after--p graf--trailing">Примечание переводчика: примеры кода дополнены комментариями, исправлены незначительные ошибки, текст незначительно сокращён для более литературно красивого перевода.</blockquote></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@stepanovv.ru" class="p-author h-card">Валерий</a> on <a href="https://medium.com/p/978994cb4d7c"><time class="dt-published" datetime="2019-01-26T21:38:57.407Z">January 26, 2019</time></a>.</p><p><a href="https://medium.com/@stepanovv.ru/%D0%BD%D0%B0%D1%87%D0%BD%D0%B8%D1%82%D0%B5-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D1%8C-ngrx-effects-%D0%B4%D0%BB%D1%8F-%D1%8D%D1%82%D0%BE%D0%B3%D0%BE-978994cb4d7c" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on August 16, 2019.</p></footer></article></body></html>